<!DOCTYPE html>
<html>
  <head>
    <script type='application/xml' id='data'>
      <envelope attack='50ms' decay='25ms' sustain='50%' release='100ms'>
        <square freq='440hz'>
          <!-- <lfo on='volume' min='75%' max='100%' freq='20hz' /> -->
          <lfo on='detune' min='-50' max='50' freq='5hz' />
        </square>
      </envelope>
    </script>
    <script>
      var ac = new AudioContext;
      ac.convolver = ac.createConvolver();
      ac.convolver.connect(ac.destination);
      function parseFreqHz(freq) {
        if (/khz$/i.test(freq)) return freq.slice(0, -3) * 1000;
        if (/hz$/i.test(freq)) return +freq.slice(0, -2);
        return NaN;
      }
      function parseVolumeGain(volume) {
        if (/%$/.test(volume)) return volume.slice(0, -1) / 100;
        return NaN;
      }
      function parseTimeSeconds(time) {
        if (/ms$/i.test(time)) return time.slice(0, -2) / 1000;
        if (/s$/i.test(time)) return time.slice(0, -1);
        return NaN;
      }
      function makeNode(soundEl, destination) {
        var gain = ac.createGain();
        gain.connect(destination);
        gain.gain.value = parseVolumeGain(soundEl.getAttribute('volume') || '100%');
        switch (soundEl.nodeName) {
          case 'envelope':
            gain.gain.value = 0;
            var attack = parseTimeSeconds(soundEl.getAttribute('attack') || '10ms');
            var decay = parseTimeSeconds(soundEl.getAttribute('decay') || '10ms');
            var sustain = parseVolumeGain(soundEl.getAttribute('sustain') || '100%');
            gain.gain.linearRampToValueAtTime(1, ac.currentTime + attack);
            if (sustain !== 1) {
              gain.gain.linearRampToValueAtTime(sustain, ac.currentTime + attack + decay);
            }
            gain.nodes = [];
            for (var childEl = soundEl.firstElementChild; childEl; childEl = childEl.nextElementSibling) {
              gain.nodes.push(makeNode(childEl, gain));
            }
            gain.addEventListener('tin-start', function delegate(e) {
              this.nodes.forEach(function(node) {
                node.dispatchEvent(new Event(e.type));
              });
            });
            var release = parseTimeSeconds(soundEl.getAttribute('release') || 0.1);
            gain.addEventListener('tin-stop', function delegate(e) {
              this.gain.linearRampToValueAtTime(0, ac.currentTime + release);
            });
            return gain;
          case 'square':
            var oscillator = ac.createOscillator();
            oscillator.type = 'square';
            oscillator.frequency.value = parseFreqHz(soundEl.getAttribute('freq'));
            oscillator.connect(gain);
            for (var childEl = soundEl.firstElementChild; childEl; childEl = childEl.nextElementSibling) {
              switch (childEl.nodeName) {
                case 'lfo':
                  var lfo = ac.createOscillator();
                  var lfoGain = ac.createGain();
                  lfo.frequency.value = parseFreqHz(childEl.getAttribute('freq'));
                  lfo.connect(lfoGain);
                  lfo.start();
                  switch (childEl.getAttribute('on')) {
                    case 'volume':
                      var min = parseVolumeGain(childEl.getAttribute('min'));
                      var max = parseVolumeGain(childEl.getAttribute('max'));
                      lfoGain.gain.value = (max - min)/2;
                      gain.gain.value = (min + max)/2;
                      lfoGain.connect(gain.gain);
                      break;
                    case 'detune':
                      var min = +childEl.getAttribute('min');
                      var max = +childEl.getAttribute('max');
                      lfoGain.gain.value = (max - min)/2;
                      oscillator.detune.value = (min + max)/2;
                      lfoGain.connect(oscillator.detune);
                      break;
                    default:
                      console.warn('unknown lfo: ' + childEl.getAttribute('on'));
                      break;
                  }
                  break;
                default:
                  console.warn('unexpected element: ' + childEl.nodeName);
                  break;
              }
            }
            gain.addEventListener('tin-start', function() { oscillator.start(); });
            gain.addEventListener('tin-stop', function() { oscillator.stop(); });
            return gain;
        }
      }
      window.onkeydown = function onkeydown(e) {
        if (e.repeat) return;
        var key = e.which;
        var doc = new DOMParser().parseFromString(document.getElementById('data').textContent, 'application/xml');
        var node = makeNode(doc.documentElement, ac.convolver);
        node.dispatchEvent(new Event('tin-start'));
        function onblur(e) {
          node.dispatchEvent(new Event('tin-stop'));
          window.removeEventListener('keyup', onkeyup);
          window.removeEventListener('blur', onblur);
        }
        function onkeyup(e) {
          if (e.which === key) onblur(e);
        }
        window.addEventListener('keyup', onkeyup);
        window.addEventListener('blur', onblur);
      };
      function loadfile() {
        var file = document.getElementById('file');
        if (file.files.length === 0) return;
        file.disabled = true;
        var fr = new FileReader;
        fr.onload = function() {
          ac.decodeAudioData(this.result, function(buffer) {
            ac.convolver.buffer = buffer;
            file.disabled = false;
          });
        };
        fr.readAsArrayBuffer(file.files[0]);
      }
    </script>
  </head>
  <body>
    <input id='file' type='file' onchange='loadfile()'>
  </body>
</html>
